
# План тестирования CompactURL

## Введение

Этот документ описывает стратегию проверки распледеленной системы CompactURL
Мы используем **Пирамиду тестирования**: от модульных тестов (Unit) до сквозных сценариев (E2E) и нагрузочных испытаний (Load).

**Окружение:**
- Docker Compose Cluster (Nginx, 2x API, 1x Router, ID Gen).
- База данных: SQLite (Persistent Volume).

---

## 1. Unit-тестирование (Backend Logic)

*Проверка изолированной логики API сервиса.*

**Инструмент:** `pytest` (внутри контейнера).
**Команда:** `docker compose exec api_service pytest`

| Тест | Описание | Ожидаемый результат |
| :--- | :--- | :--- |
| `test_shorten_success` | Успешное создание ссылки (Mocked Router) | JSON с `short_code` |
| `test_redirect_success` | Успешный редирект | Статус 307, заголовок `Location` |
| `test_shorten_retry` | Проверка Retry-механизма при 503 от Роутера | Успех после повторной попытки |

---

## 2. Функциональное E2E тестирование (API)

*Проверка работы всей системы в сборе.*

**Инструмент:** `python3 tests/e2e_test.py`

### Тест 2.1: Полный цикл
*   **Сценарий:** `POST /shorten` -> `GET /{code}`.
*   **Результат:** Ссылка создается, редирект работает корректно.

### Тест 2.2: Обработка ошибок
*   **Сценарий A:** Запрос несуществующего кода (`/NonExistent123`).
    *   *Ожидание:* HTTP 404 Not Found.
*   **Сценарий B:** Отправка пустого URL.
    *   *Ожидание:* HTTP 422 Unprocessable Entity (Валидация).

---

## 3. Архитектурное тестирование

*Проверка ключевых фич: Шардирование и Отказоустойчивость.*

### Тест 3.1: Динамическое шардирование
**Инструмент:** `python3 tests/test_sharding.py`
**Предусловие:** `SHARD_LIMIT=1000` (в docker-compose.yml).
*   **Сценарий:** Генерация 1200 ссылок.
*   **Проверка:**
    1.  В папке `data/` созданы файлы `shard_0.db`, `shard_1.db`.
    2.  Роутер автоматически переключается на новый файл.
    3.  Ошибок записи нет.

### Тест 3.2: Персистентность
**Инструмент:** Ручной.
*   **Сценарий:**
    1.  Сократить ссылку.
    2.  `docker compose restart`.
    3.  Перейти по ссылке.
*   **Результат:** Ссылка работает. Данные не потеряны.

---

## 4. Нагрузочное тестирование

*Проверка производительности и обработки конкуренции.*

**Инструмент:** `python3 tests/stress_test.py`

### Тест 4.1: Стресс-тест записи
*   **Параметры:** 50 потоков, 2500 запросов.
*   **Результат:**
    -   Система выдерживает нагрузку (RPS > 50).
    -   <1% ошибок.
.

---

## 5. Демонстрационный тест

### Тест 5.1: Дымовой тест
**Инструмент:** `python3 tests/smoke_test.py`
*   **Цель:** Быстро показать, что "все лампочки горят".

### Тест 5.2: UI/UX (Ручной)
*   **Сценарий:**
    1.  Открыть `http://localhost`.
    2.  Показать анимацию и панель команды.
    3.  Сократить ссылку.
    4.  Показать лог Nginx (`docker logs -f compact_gateway`), чтобы продемонстрировать балансировку запросов между API репликами.
